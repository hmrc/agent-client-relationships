%% Last Updated: 2025-11-20
%% Git Commit SHA: b2138b4e3958677748c1820c3d715d4fbb9d3b2c
%% Analysis Version: 1.0

sequenceDiagram
    participant Client
    participant RC as RelationshipsController
    participant OS as OrchestratorService
    participant VS as ValidationService
    participant DRS as DeleteRelationshipsService
    participant Mongo as MongoDB<br/>(DeleteRecordRepository)
    participant CRS as CheckRelationshipsService
    participant ESP as Enrolment Store Proxy<br/>EACD
    participant UGS as users-groups-search
    participant AP as agent-permissions
    participant CACRS as CheckAndCopyRelationshipsService
    participant HIP as IF/HIP
    participant DES
    participant AM as agent-mapping
    participant AFI as agent-fi-relationship
    participant AA as agent-assurance

    Client->>+RC: GET /agent/:arn/service/:service/client/:clientIdType/:clientId?userId=xxx
    Note over RC: authorised() validation

    RC->>+OS: checkForRelationship(arn, service, clientIdType, clientId, userId)

    alt Special case: IR-SA with NINO
        OS->>+AA: getNonSuspendedAgentRecord(arn)
        AA-->>-OS: Agent record or None (if suspended)
        OS->>+CACRS: hasPartialAuthOrLegacyRelationshipInCesa(arn, nino)
        CACRS-->>-OS: true/false
    else Special case: MTD-IT with NINO
        OS->>+HIP: getMtdIdFor(nino)
        HIP-->>-OS: MtdItId or None
        OS->>OS: Convert to EnrolmentKey
    else Special case: HMCE-VATDEC-ORG
        OS->>+CACRS: lookupESForOldRelationship(arn, vrn)
        CACRS->>+ESP: getDelegatedGroupIdsFor(vrn)
        ESP-->>-CACRS: Group IDs
        CACRS-->>-OS: References
    else Special case: PIR
        OS->>+AFI: getRelationship(arn, service, clientId)
        AFI-->>-OS: Relationship or None
    else Normal flow
        OS->>+VS: validateForEnrolmentKey(service, clientIdType, clientId)
        VS-->>-OS: EnrolmentKey or error

        OS->>+DRS: checkDeleteRecordAndEventuallyResume(arn, enrolmentKey)
        DRS->>+Mongo: findBy(arn, enrolmentKey)
        Mongo-->>-DRS: DeleteRecord or None
        alt DeleteRecord exists and not timed out
            DRS->>DRS: resumeRelationshipRemoval(record)
            DRS-->>OS: false (relationship pending deletion)
        else No DeleteRecord or timed out
            DRS-->>-OS: true (proceed)
        end

        OS->>+CRS: checkForRelationship(arn, userId, enrolmentKey)
        CRS->>+ESP: getPrincipalGroupIdFor(arn)
        ESP-->>-CRS: Agent's group ID
        CRS->>+ESP: getDelegatedGroupIdsFor(enrolmentKey)
        ESP-->>-CRS: Client's delegated group IDs

        alt userId provided (user-level check)
            CRS->>+UGS: getGroupUsers(groupId)
            Note over UGS: users-groups-search
            UGS-->>-CRS: Group users
            CRS->>CRS: Check if userId belongs to group
            alt User belongs to group
                CRS->>+AP: isClientUnassigned(arn, enrolmentKey)
                Note over AP: agent-permissions
                AP-->>-CRS: true/false (unassigned?)
                CRS->>+ESP: getEnrolmentsAssignedToUser(userId, service)
                ESP-->>-CRS: User's assigned enrolments
                CRS->>CRS: Check if client is unassigned OR assigned to user
            end
        end

        CRS-->>-OS: true/false

        alt Relationship not found
            OS->>+CACRS: checkForOldRelationshipAndCopy(arn, enrolmentKey)

            alt MTD-IT service
                CACRS->>+HIP: getMtdIdFor(nino)
                HIP-->>-CACRS: MtdItId
                CACRS->>+DES: getClientSaAgentSaReferences(nino)
                DES-->>-CACRS: SA Agent References
                CACRS->>+AM: getSaAgentReferencesFor(arn)
                AM-->>-CACRS: Agent's SA references
                alt References match
                    CACRS->>CACRS: Copy relationship to ES
                end
            else Other services
                CACRS->>+DES: Check legacy relationship
                DES-->>-CACRS: Legacy relationship data
            end

            CACRS-->>-OS: CheckAndCopyResult
        end
    end

    OS-->>-RC: CheckRelationshipResult

    alt CheckRelationshipFound
        RC-->>Client: 200 OK
    else CheckRelationshipNotFound
        RC-->>Client: 404 Not Found
    else CheckRelationshipInvalidRequest
        RC-->>-Client: 400 Bad Request
    end
