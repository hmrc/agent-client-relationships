{
    "apiId": "ACR06",
    "apiTitle": "Get Client Inactive Relationships",
    "description": "Retrieves all inactive (terminated) agent-client relationships for the authenticated client across all their enrolled services (excluding PIR). The endpoint extracts tax identifiers from the client's Government Gateway enrolments and queries ETMP via HIP to find inactive agent relationships for each service. Returns an array of InactiveRelationship objects containing agent ARN, service, client ID, dates, and client type.",
    "method": "GET",
    "path": "/client/relationships/inactive",
    "pathParameters": {},
    "queryParameters": {},
    "responses": {
        "200": "Returns JSON array of InactiveRelationship objects - empty array if no inactive relationships",
        "401": "Unauthorized - client not authenticated via Government Gateway",
        "403": "Forbidden - user is not an Individual or Organisation (no permission to perform operation)"
    },
    "authentication": "Client authentication via Government Gateway (Individual or Organisation)",
    "audience": "internal",
    "controller": "RelationshipsController",
    "controllerMethod": "getInactiveRelationshipsForClient",
    "services": [
        {
            "name": "FindRelationshipsService",
            "alias": "FRS",
            "method": "getInactiveRelationshipsForClient",
            "description": "Orchestrates retrieval of inactive relationships across all client's enrolled services"
        },
        {
            "name": "HipConnector",
            "alias": "HIP",
            "method": "getInactiveClientRelationships",
            "description": "Queries ETMP via HIP for inactive agent relationships for each service"
        }
    ],
    "interactions": [
        {
            "step": 1,
            "actor": "RelationshipsController (RC)",
            "action": "authenticates",
            "target": "Client",
            "method": "withAuthorisedAsClient",
            "description": "Validates client via Gov Gateway, retrieves all enrolments"
        },
        {
            "step": 2,
            "actor": "RelationshipsController (RC)",
            "action": "extracts identifiers",
            "target": "RelationshipsController (RC)",
            "description": "Builds Map[Service, TaxIdentifier] from client's enrolments for supported services"
        },
        {
            "step": 3,
            "actor": "RelationshipsController (RC)",
            "action": "calls service",
            "target": "FindRelationshipsService (FRS)",
            "method": "getInactiveRelationshipsForClient",
            "description": "Passes map of service to tax identifier for relationship lookup"
        },
        {
            "step": 4,
            "actor": "FindRelationshipsService (FRS)",
            "action": "traverses services",
            "target": "FindRelationshipsService (FRS)",
            "description": "Iterates through supportedServicesWithoutPir, checking each service"
        },
        {
            "step": 5,
            "actor": "FindRelationshipsService (FRS)",
            "action": "calls connector",
            "target": "HipConnector (HIP)",
            "method": "getInactiveClientRelationships",
            "description": "For each enrolled service, queries HIP for inactive relationships",
            "conditional": "only if client has enrolment for the service"
        },
        {
            "step": 6,
            "actor": "HipConnector (HIP)",
            "action": "builds URL",
            "target": "HipConnector (HIP)",
            "description": "Constructs HIP URL with taxIdentifier, authProfile, and activeOnly=false"
        },
        {
            "step": 7,
            "actor": "HipConnector (HIP)",
            "action": "calls external API",
            "target": "IF/HIP â†’ ETMP",
            "endpoint": "/etmp/RESTAdapter/rosm/agent-relationship",
            "method": "GET",
            "queryParams": {
                "idType": "Tax identifier type (e.g., MTDITID, VRN, UTR)",
                "refNumber": "Tax identifier value",
                "auth-profile": "Service-specific auth profile (ITSA, VATC, TRS, etc.)",
                "active-only": "false (to include inactive relationships)"
            },
            "description": "Queries ETMP for all agent relationships (active and inactive) via HIP REST Adapter"
        },
        {
            "step": 8,
            "actor": "ETMP",
            "action": "returns response",
            "target": "HipConnector (HIP)",
            "description": "Returns relationshipDisplayResponse array with relationship data",
            "conditional": "on success (200 OK)"
        },
        {
            "step": 9,
            "actor": "HipConnector (HIP)",
            "action": "filters results",
            "target": "HipConnector (HIP)",
            "method": "isNotActive",
            "description": "Filters to only inactive relationships (dateTo is present AND dateTo <= today)"
        },
        {
            "step": 10,
            "actor": "HipConnector (HIP)",
            "action": "returns data",
            "target": "FindRelationshipsService (FRS)",
            "description": "Returns Seq[InactiveRelationship]"
        },
        {
            "step": 11,
            "actor": "FindRelationshipsService (FRS)",
            "action": "collects results",
            "target": "FindRelationshipsService (FRS)",
            "description": "Accumulates inactive relationships from all services"
        },
        {
            "step": 12,
            "actor": "FindRelationshipsService (FRS)",
            "action": "flattens results",
            "target": "FindRelationshipsService (FRS)",
            "description": "Flattens Seq[Seq[InactiveRelationship]] to Seq[InactiveRelationship]"
        },
        {
            "step": 13,
            "actor": "FindRelationshipsService (FRS)",
            "action": "returns data",
            "target": "RelationshipsController (RC)",
            "description": "Returns flattened Seq[InactiveRelationship]"
        },
        {
            "step": 14,
            "actor": "RelationshipsController (RC)",
            "action": "returns response",
            "target": "Client",
            "description": "Returns 200 OK with JSON array of inactive relationships"
        }
    ],
    "externalDependencies": [
        {
            "name": "IF/HIP",
            "alias": "HIP",
            "description": "HMRC Integration Platform - provides access to ETMP agent relationships"
        },
        {
            "name": "ETMP",
            "description": "Enterprise Tax Management Platform - stores historical agent-client relationship records"
        }
    ],
    "databaseCollections": [],
    "authenticationDetails": {
        "provider": "GovernmentGateway",
        "affinityGroups": ["Individual", "Organisation"],
        "enrolmentsRequired": "At least one supported service enrolment",
        "retrieves": "allEnrolments",
        "noEnrolmentsResponse": "403 Forbidden (NoPermissionToPerformOperation)"
    },
    "supportedServices": [
        "HMRC-MTD-IT",
        "HMRC-MTD-IT-SUPP",
        "HMRC-MTD-VAT",
        "HMRC-TERS-ORG",
        "HMRC-TERSNT-ORG",
        "HMRC-CGT-PD",
        "HMRC-PPT-ORG",
        "HMRC-CBC-ORG",
        "HMRC-PILLAR2-ORG"
    ],
    "excludedServices": [
        "PERSONAL-INCOME-RECORD (PIR) - handled by separate service"
    ],
    "responseModel": {
        "InactiveRelationship": {
            "arn": "Agent Reference Number (e.g., TARN0000001)",
            "dateTo": "Optional[LocalDate] - date relationship ended (must be <= today to be included)",
            "dateFrom": "Optional[LocalDate] - date relationship started",
            "clientId": "Client identifier (MTD-IT ID, VRN, UTR, CGT ref, etc.)",
            "clientType": "Either 'personal' or 'business' based on ETMP response",
            "service": "Service identifier derived from clientId format (e.g., HMRC-MTD-IT, HMRC-MTD-VAT)"
        },
        "example": [
            {
                "arn": "TARN0000001",
                "dateTo": "2025-10-15",
                "dateFrom": "2024-01-20",
                "clientId": "XXIT00000000001",
                "clientType": "personal",
                "service": "HMRC-MTD-IT"
            },
            {
                "arn": "TARN0000002",
                "dateTo": "2025-11-01",
                "dateFrom": "2023-05-10",
                "clientId": "123456789",
                "clientType": "business",
                "service": "HMRC-MTD-VAT"
            }
        ]
    },
    "inactiveRelationshipCriteria": {
        "dateTo": "Must be present (not None) AND on or before today",
        "isNotActive": "Filters relationships where dateTo.isBefore(today) OR dateTo.equals(today)",
        "activeOnly": "Query parameter set to false to retrieve both active and inactive, then filtered client-side"
    },
    "errorHandling": [
        {
            "scenario": "ETMP returns 400 or 404",
            "handling": "Returns empty Seq for that service (contributes nothing to results)"
        },
        {
            "scenario": "ETMP returns 422 with 'suspended' message",
            "handling": "Agent suspended - returns empty Seq for that service"
        },
        {
            "scenario": "ETMP returns 422 with error code '009'",
            "handling": "ETMP error - returns empty Seq for that service"
        },
        {
            "scenario": "ETMP returns other error",
            "handling": "Logs error, returns empty Seq for that service"
        },
        {
            "scenario": "Client has no supported enrolments",
            "handling": "Returns 403 Forbidden (NoPermissionToPerformOperation)"
        },
        {
            "scenario": "Client not authenticated",
            "handling": "Returns 401 Unauthorized"
        },
        {
            "scenario": "All services return errors or no inactive relationships",
            "handling": "Returns 200 OK with empty array []"
        }
    ],
    "businessLogic": {
        "enrolmentExtraction": "For each supported service, extracts first tax identifier from matching enrolment",
        "serviceTraversal": "Uses Future.traverse to query all services in parallel",
        "resultFlattening": "Flattens Seq[Seq[InactiveRelationship]] to single flat array",
        "emptyServices": "Services without enrolments or with errors contribute empty Seq to results",
        "authProfile": "Each service has a specific auth-profile parameter (ITSA, VATC, TRS, TRSNT, CGT, PPT, CBC, PLR)",
        "clientSideFiltering": "ETMP returns all relationships (activeOnly=false), then isNotActive filters client-side"
    },
    "useCases": [
        {
            "scenario": "Client viewing their relationship history",
            "response": "Shows all past agent authorizations that have ended"
        },
        {
            "scenario": "Client auditing previous agent access",
            "response": "Can see which agents previously had access and when relationships ended"
        },
        {
            "scenario": "Frontend displaying terminated relationships timeline",
            "response": "Can build historical view with agent names and end dates"
        }
    ],
    "importantNotes": [
        "Returns inactive relationships only - active relationships are excluded by isNotActive filter",
        "PIR (Personal Income Record) is excluded - handled by agent-fi-relationship service",
        "Client must have at least one supported service enrolment",
        "Services are queried in parallel for performance",
        "Empty array [] returned if no inactive relationships found (not 404)",
        "Relationships from multiple services are combined in a flat array",
        "ETMP queried with activeOnly=false, then filtered to only inactive",
        "Auth profile parameter varies by service type",
        "Service field is automatically derived from clientId format",
        "dateTo must be on or before today to be included (relationships ending in future excluded)"
    ],
    "comparisonWithACR02": {
        "similarities": [
            "Both query ETMP via HIP for inactive relationships",
            "Both use isNotActive filtering (dateTo present and <= today)",
            "Both use same InactiveRelationship model",
            "Both use service-specific auth profiles"
        ],
        "differences": [
            "ACR02: Agent-side view (given ARN, find all client relationships)",
            "ACR06: Client-side view (given client enrolments, find all agent relationships)",
            "ACR02: Single ETMP query with ARN parameter",
            "ACR06: Multiple ETMP queries (one per enrolled service)",
            "ACR02: Uses agent authentication",
            "ACR06: Uses client authentication with enrolment extraction"
        ]
    }
}

