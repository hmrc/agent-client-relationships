%% Last Updated: 2025-11-20
%% Git Commit SHA: b2138b4e3958677748c1820c3d715d4fbb9d3b2c
%% Analysis Version: 1.0

sequenceDiagram
    participant Client
    participant RC as RelationshipsController
    participant FRS as FindRelationshipsService
    participant HIP as IF/HIP (HipConnector)
    participant ETMP as ETMP (via HIP REST Adapter)

    Client->>+RC: GET /client/relationships/inactive
    Note over RC: withAuthorisedAsClient<br/>Extract enrolments from Gov Gateway auth

    RC->>RC: Build Map[Service, TaxIdentifier]<br/>from client's enrolments
    Note over RC: For each supported service,<br/>extract tax identifier from enrolment

    RC->>+FRS: getInactiveRelationshipsForClient(identifiers)

    loop For each supportedService (excluding PIR)
        alt Client has enrolment for this service
            FRS->>FRS: Extract tax identifier for service
            FRS->>+HIP: getInactiveClientRelationships(taxId, service)

            HIP->>HIP: Build HIP URL with:<br/>- taxIdentifier<br/>- authProfile for service<br/>- activeOnly=false

            HIP->>+ETMP: GET /etmp/RESTAdapter/rosm/agent-relationship<br/>?idType={idType}&refNumber={taxId}<br/>&auth-profile={authProfile}&active-only=false
            Note over HIP,ETMP: Includes HIP subscription headers

            alt Success (200 OK)
                ETMP-->>-HIP: relationshipDisplayResponse array
                HIP->>HIP: Filter with isNotActive:<br/>(dateTo is present AND dateTo <= today)
                HIP-->>-FRS: Seq[InactiveRelationship]
                FRS->>FRS: Add to results
            else Client Error (400/404)
                ETMP-->>HIP: Error response
                HIP-->>FRS: Empty Seq
            else Agent Suspended (422 with "suspended")
                ETMP-->>HIP: Unprocessable Entity
                HIP-->>FRS: Empty Seq
            else ETMP Error Code 009 (422)
                ETMP-->>HIP: Unprocessable Entity
                HIP-->>FRS: Empty Seq
            else Other Error
                ETMP-->>HIP: Error response
                Note over HIP: Log error
                HIP-->>FRS: Empty Seq
            end
        else No enrolment for this service
            FRS->>FRS: Skip (return empty Seq)
        end
    end

    FRS->>FRS: Flatten all results<br/>Seq[InactiveRelationship]
    FRS-->>-RC: Seq[InactiveRelationship]

    RC-->>-Client: 200 OK with JSON array

