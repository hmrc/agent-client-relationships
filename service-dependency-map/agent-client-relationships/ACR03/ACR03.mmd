%% Last Updated: 2025-11-20
%% Git Commit SHA: b2138b4e3958677748c1820c3d715d4fbb9d3b2c
%% Analysis Version: 1.0

sequenceDiagram
    participant Caller as Internal Service/Admin
    participant RC as RelationshipsController
    participant ATS as AgentTerminationService
    participant IR as InvitationsRepository
    participant PAR as PartialAuthRepository
    participant ARR as AgentReferenceRepository
    participant Mongo as MongoDB

    Caller->>+RC: DELETE /agent/:arn/terminate
    Note over RC: withBasicAuth(expectedAuth)<br/>Validates HTTP Basic Auth credentials

    alt Valid Basic Auth
        RC->>+ATS: terminateAgent(arn)

        par Delete from invitations collection
            ATS->>+IR: terminateAgent(arn)
            IR->>+Mongo: deleteMany({"arn": arn})<br/>Collection: invitations
            Mongo-->>-IR: DeleteResult with count
            IR-->>-ATS: Right(deletedCount)
        and Delete from partial-auth collection
            ATS->>+PAR: terminateAgent(arn)
            PAR->>+Mongo: deleteMany({"arn": arn})<br/>Collection: partial-auth
            Mongo-->>-PAR: DeleteResult with count
            PAR-->>-ATS: Right(deletedCount)
        and Delete from agent-reference collection
            ATS->>+ARR: terminateAgent(arn)
            ARR->>+Mongo: deleteMany({"arn": arn})<br/>Collection: agent-reference
            Mongo-->>-ARR: DeleteResult with count
            ARR-->>-ATS: Right(deletedCount)
        end

        ATS->>ATS: Build TerminationResponse with deletion counts
        ATS-->>-RC: TerminationResponse

        RC-->>Caller: 200 OK with JSON response
    else Invalid/Missing Basic Auth
        RC-->>-Caller: 401 Unauthorized
    end

    alt MongoDB Error
        Mongo-->>IR: MongoWriteException
        IR-->>ATS: Left(errorMessage)
        ATS-->>RC: EitherT.Left(error)
        RC-->>Caller: 500 Internal Server Error
    end

