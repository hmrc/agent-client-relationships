%% Last Updated: 2025-11-20
%% Git Commit SHA: b2138b4e3958677748c1820c3d715d4fbb9d3b2c
%% Analysis Version: 1.0

sequenceDiagram
    participant Client as External System
    participant AGIC as ApiGetInvitationController
    participant AAS as AgentAssuranceService
    participant AA as Agent Assurance
    participant ILS as InvitationLinkService
    participant ARR as AgentReferenceRepository
    participant ARRDB as agent-references
    participant IR as InvitationsRepository
    participant IDB as invitations

    Client->>AGIC: GET /api/{arn}/invitation/{invitationId}
    Note over AGIC: OAuth2 Authentication Check

    AGIC->>AAS: getNonSuspendedAgentRecord(arn)
    AAS->>AA: GET /agent-assurance/agent/{arn}

    alt Agent Found and Not Suspended
        AA-->>AAS: Agent record
        AAS-->>AGIC: Some(agentRecord)

        AGIC->>ILS: normaliseAgentName(agencyName)
        ILS-->>AGIC: normalizedAgentName

        AGIC->>ILS: getAgentReferenceRecordByArn(arn, normalizedName)
        ILS->>ARR: findByArn(arn)
        ARR->>ARRDB: Find by ARN

        alt Agent Reference Exists
            ARRDB-->>ARR: AgentReferenceRecord
            ARR-->>ILS: Some(record)
        else Agent Reference Not Found
            ARRDB-->>ARR: None
            ARR-->>ILS: None
            Note over ARR: create(new AgentReferenceRecord)
            ARR->>ARRDB: Insert new record with uid
            ARRDB-->>ARR: Created
            ARR-->>ILS: AgentReferenceRecord
        end
        ILS-->>AGIC: AgentReferenceRecord with uid

        AGIC->>IR: findOneById(invitationId)
        IR->>IDB: Find by invitationId

        alt Invitation Found
            IDB-->>IR: Invitation
            IR-->>AGIC: Some(invitation)

            alt ARN Matches Invitation's Agent
                alt Service Supported
                    AGIC-->>Client: 200 OK - ApiInvitationResponse
                else Service Not Supported
                    AGIC-->>Client: 422 UNSUPPORTED_SERVICE
                end
            else ARN Mismatch
                AGIC-->>Client: 422 NO_PERMISSION_ON_AGENCY
            end
        else Invitation Not Found
            IDB-->>IR: None
            IR-->>AGIC: None
            AGIC-->>Client: 422 INVITATION_NOT_FOUND
        end

    else Agent Suspended or Not Found
        AA-->>AAS: None (suspended/not found)
        AAS-->>AGIC: None
        AGIC-->>Client: 422 AGENT_SUSPENDED
    end
