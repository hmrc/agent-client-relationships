service: agent-client-relationships
prefix: ACR
repository: https://github.com/hmrc/agent-client-relationships
capabilities: []
audience:
  - internal
interaction: synchronous
criticality: high
lifecycle: active
dependencies:
  consumes:
    - enrolment-store-proxy
    - users-groups-search
    - agent-permissions
    - ETMP
    - DES
    - agent-mapping
    - agent-fi-relationship
    - agent-assurance
    - citizen-details
    - email
    - MongoDB
tags: []
apis:
  - id: ACR01
    method: GET
    path: /agent/{arn}/service/{service}/client/{clientIdType}/{clientId}
    description: Checks if a relationship exists between an agent and a client for a specific service.
    audience: internal
    interaction: synchronous
    consumes:
      - ES3 # Check enrolment allocation (gets principal group ID)
      - ES1 # Query known facts (gets delegated group IDs)
      - UGS01 # Get user by group ID (for user-level permission checks)
      - ES2 # Query enrolments by group ID (gets user's assigned enrolments)
      - AP06 # Check access group contains client
      - ETMP06 # Get ITSA Business Details (converts NINO to MtdItId for MTD-IT)
      - DES08 # Get SA Agent Client Authorisation Flags (legacy CESA relationships)
      - AM09 # Find mappings for multiple keys (maps ARN to legacy SA references)
      - AFR01 # Get relationship for NINO (PIR relationship checks)
      - AA27 # Get agent record by ARN (checks agent suspension status for IR-SA)

  - id: ACR03
    method: DELETE
    path: /agent/{arn}/terminate
    description: Administrative endpoint that deletes internal tracking records from MongoDB for a terminated agent. Does NOT terminate actual relationships in EACD.
    audience: internal
    interaction: synchronous
    consumes:
      - MongoDB.invitations.DELETE
      - MongoDB.partial-auth.DELETE
      - MongoDB.agent-reference.DELETE
  - id: ACR08
    method: GET
    path: /client/authorisations-relationships
    description: Most complex endpoint - retrieves comprehensive tax agent data combining active/inactive relationships, pending invitations, event timeline, and agent details. Queries 4 sources in parallel (ETMP, agent-fi-relationship, invitations DB, partial_auth DB) with agent name enrichment.
    audience: internal
    interaction: synchronous
    consumes:
      - ETMP03 # Get active relationships (via HIP - queries ETMP for relationships per service)
      - AFR01 # Get relationship for NINO (PIR relationships)
      - MongoDB.invitations.READ_MANY
      - MongoDB.partial-auth.READ_MANY
  - id: ACR09
    method: GET
    path: /client/{service}/details/{clientId}
    description: Retrieves client details (name, known facts, overseas status) from external APIs, then enriches with pending invitation and existing relationship checks. For MTD-IT checks both main and supporting services. Uses full ACR01 flow for relationship checks.
    audience: internal
    interaction: synchronous
    consumes:
      - CD02 # Get citizen details by NINO (for PIR service)
      - ETMP05 # Get NINO for MTD IT ID (for MTD-IT services)
      - MongoDB.invitations.READ
      - MongoDB.partial-auth.READ
      # Uses ACR01 flow for relationship checks
  - id: ACR10
    method: GET
    path: /agent/agent-reference/uid/{uid}/{normalizedAgentName}
    description: Public endpoint (no auth) that validates agent invitation links. Verifies UID exists, normalized name matches (from array of names), and agent not suspended. Returns agent details or 404/403. Two-factor security prevents link guessing.
    audience: internal
    interaction: synchronous
    consumes:
      - AA27 # Get agent record by ARN (checks agent suspension status and retrieves agent details)
      - MongoDB.agent-reference.READ
  - id: ACR11
    method: GET
    path: /agent/agent-link
    description: Idempotent create/get agent invitation link. First call generates UID and creates record. Subsequent calls return existing UID. When agency name changes, adds new normalized name to array (old links continue working). Works even if agent suspended.
    audience: internal
    interaction: synchronous
    consumes:
      - AA27 # Get agent record by ARN (retrieves agent details including agency name)
      - MongoDB.agent-reference.READ
      - MongoDB.agent-reference.WRITE
      - MongoDB.agent-reference.UPDATE
  - id: ACR12
    method: POST
    path: /client/validate-invitation
    description: Validates invitation for authenticated client. Checks UID, agent suspension, finds matching invitations (Pending first, else most recent), and checks for existing main agent. Returns invitation details with existingMainAgent info. Handles service mappings (HMRC-NI/PT â†’ MTD-IT/PIR).
    audience: internal
    interaction: synchronous
    consumes:
      - AA27 # Get agent record by ARN (agent suspension check and agent details)
      - ES1 # Query known facts (checks for existing agent delegations)
      - AFR01 # Get relationship for NINO (PIR relationship checks)
      - MongoDB.agent-reference.READ
      - MongoDB.invitations.READ
  - id: ACR13
    method: GET
    path: /client/authorisation-request-info/{invitationId}
    description: Gets basic invitation info (agent name, service, status) for agent OR client. Unusual auth pattern - lookups invitation first, then validates user is agent (matching ARN) OR client (matching clientId). Returns details even if agent suspended.
    audience: internal
    interaction: synchronous
    consumes:
      - AA27 # Get agent record by ARN (retrieves agent details including agency name)
      - MongoDB.invitations.READ
  - id: ACR14
    method: GET
    path: /agent/{arn}/details
    description: Simple passthrough to agent-assurance - retrieves agent details (name, email, suspension status). Agent auth required but no validation that ARN matches authenticated agent (any agent can query any agent). Returns details even if agent suspended.
    audience: internal
    interaction: synchronous
    consumes:
      - AA27 # Get agent record by ARN
  - id: ACR15
    method: PUT
    path: /client/authorisation-response/reject/{invitationId}
    description: Client or Stride user rejects pending invitation. Two-phase auth (lookup first, validate after). Updates status to Rejected, sends email to agent, audits event. Returns 204 No Content. Can only reject Pending invitations (403 for other statuses).
    audience: internal
    interaction: synchronous
    consumes:
      - MongoDB.invitations.READ
      - MongoDB.invitations.UPDATE
      - EMAIL01 # Send email (rejection notification to agent)
  - id: ACR16
    method: PUT
    path: /authorisation-response/accept/{invitationId}
    description: MOST COMPLEX ENDPOINT - Client or Stride accepts invitation and CREATES actual relationship in EACD (allocateEnrolmentToAgent) and/or ETMP. Service-specific flows for PIR/MTD-IT/MTD-IT-SUPP/Alt-ITSA/others. Deauths existing agents, manages partial auth, updates status to Accepted/PartialAuth, sends email. Can return 423 Locked.
    audience: internal
    interaction: synchronous
    consumes:
      - ES4 # Allocate enrolment to agent (creates delegation)
      - ETMP01 # Create agent relationship (creates tax service relationships via HIP)
      - AFR02 # Create relationship (creates PIR relationships)
      - EMAIL01 # Send email (acceptance confirmation)
      - MongoDB.invitations.UPDATE
      - MongoDB.partial-auth.WRITE
      - MongoDB.partial-auth.DELETE
  - id: ACR17
    method: POST
    path: /agent/{arn}/authorisation-request
    description: Agent creates invitation (Pending status). Gets agent details from agent-assurance. For MTD-IT/MTD-IT-SUPP with NINO, converts to MTD IT ID via IF/HIP (uses NINO if not found for alt-itsa). Prevents duplicates via MongoDB unique index. Returns 201 with invitationId. Does NOT send email.
    audience: internal
    interaction: synchronous
    consumes:
      - AA27 # Get agent record by ARN (retrieves agent details: agency name, email)
      - ETMP05 # Get NINO for MTD IT ID (converts NINO to MTD IT ID for MTD-IT/MTD-IT-SUPP)
      - MongoDB.invitations.WRITE
  - id: ACR18
    method: GET
    path: /agent/{arn}/authorisation-request-info/{invitationId}
    description: Retrieves details about a specific authorisation request (invitation) for an agent, including a shareable invitation link. Returns full invitation details with generated link (UID and normalized agent name) for client onboarding. Creates or retrieves agent-reference record with unique UID. Returns details even if agent suspended.
    audience: internal
    interaction: synchronous
    consumes:
      - AA27 # Get agent record by ARN (retrieves agent details including agency name)
      - MongoDB.invitations.READ
      - MongoDB.agent-reference.READ
      - MongoDB.agent-reference.WRITE
      - MongoDB.agent-reference.UPDATE
  - id: ACR19
    method: GET
    path: /agent/{arn}/authorisation-requests
    description: Retrieves paginated and filtered list of authorisation requests (invitations) for an agent. Uses MongoDB aggregation with facets for efficient querying (single query returns data + metadata). Returns requests filtered by status and client name, plus metadata (clientNames, availableFilters, totalResults, filtersApplied). Special handling - 'Accepted' filter includes PartialAuth. Primary endpoint for agent dashboards.
    audience: internal
    interaction: synchronous
    consumes:
      - MongoDB.invitations.READ_MANY
  - id: ACR20
    method: POST
    path: /agent/{arn}/remove-authorisation
    description: HIGH COMPLEXITY - Removes existing authorisation between agent and client. Three distinct flows - 1) PIR delegates to agent-fi-relationship. 2) Alt-ITSA (MTD-IT/ITSUPP+NINO) deauths partial-auth and updates invitations. 3) Standard services perform full deletion with EACD enrolment deallocation and ETMP relationship removal. Uses recovery mechanism with delete-record tracking. Not atomic. Supports agent/client/Stride auth.
    audience: internal
    interaction: synchronous
    consumes:
      - AFR03 # Delete relationship (PIR service only)
      - ES3 # Check enrolment allocation (gets principal group ID)
      - ES5 # Deallocate enrolment from agent (standard services)
      - ETMP02 # Delete agent relationship (standard services via HIP)
      - ETMP05 # Get NINO for MTD IT ID (Alt-ITSA - NINO to MTDITID conversion)
      - MongoDB.invitations.UPDATE
      - MongoDB.partial-auth.UPDATE
      - MongoDB.delete-record.READ
      - MongoDB.delete-record.WRITE
      - MongoDB.delete-record.UPDATE
      - MongoDB.delete-record.DELETE
  - id: ACR21
    method: PUT
    path: /agent/cancel-invitation/{invitationId}
    description: Allows agent to cancel pending authorisation request (invitation) they previously sent to client. Only Pending status invitations can be cancelled. Agent must own invitation (ARN must match). Atomic update with validation prevents race conditions. Updates status to Cancelled and lastUpdated timestamp. Client can no longer accept cancelled invitation. Does not send email notification to client.
    audience: internal
    interaction: synchronous
    consumes:
      - MongoDB.invitations.READ
      - MongoDB.invitations.UPDATE
  - id: ACR22
    method: POST
    path: /itsa-post-signup/create-relationship/{nino}
    description: HIGH COMPLEXITY - Creates ITSA (MTD-IT) relationship for client after MTD signup. Two flows - 1) Partial auth conversion (converts existing partial auth to full relationship, deletes partial auth, updates invitation to Accepted). 2) Legacy SA copy (copies SA relationship from CESA/DES to MTD-IT if no partial auth). Converts NINO to MTDITID via HIP. Uses recovery mechanism. Cleans up duplicate same-agent relationships. Returns service in response.
    audience: internal
    interaction: synchronous
    consumes:
      - ETMP05 # Get NINO for MTD IT ID (NINO to MTDITID conversion)
      - ETMP01 # Create agent relationship (ETMP relationship creation via HIP)
      - DES08 # Get SA Agent Client Authorisation Flags (legacy SA copy flow - retrieves SA agent references)
      - ES3 # Check enrolment allocation (gets principal group ID)
      - ES4 # Allocate enrolment to agent (both flows - enrolment allocation)
      - MongoDB.partial-auth.READ
      - MongoDB.partial-auth.DELETE
      - MongoDB.invitations.UPDATE
      - MongoDB.relationship-copy-record.WRITE
      - MongoDB.relationship-copy-record.DELETE
  - id: ACR23
    method: POST
    path: /invitations/trusts-enrolment-orchestrator/{urn}/update
    description: Updates a trust-related invitation by replacing the temporary URN with the permanent UTR after trust registration completes. Called by Trusts Enrolment Orchestrator when trust transitions from non-taxable (HMRC-TERSNT-ORG) to taxable (HMRC-TERS-ORG) status. Updates invitation record atomically (service, clientId, clientIdType, suppliedClientId, suppliedClientIdType, lastUpdated). No authentication required - internal service call.
    audience: internal
    interaction: synchronous
    consumes:
      - MongoDB.invitations.UPDATE
  - id: ACR24
    method: GET
    path: /customer-status
    description: MEDIUM COMPLEXITY - Returns client relationship status summary with three boolean flags (hasPendingInvitations, hasInvitationsHistory, hasExistingRelationships). Filters out suspended agent invitations via Agent Assurance. Checks multiple sources (invitations, partial auth, IRV, ETMP). Uses 15-min caching for ETMP queries. Short-circuits ETMP check if active partial auth, IRV, or PartialAuth/Accepted invitation exists.
    audience: internal
    interaction: synchronous
    consumes:
      - AA27 # Get agent record by ARN (checks agent suspension status for filtering invitations)
      - AFR01 # Get relationship for NINO (checks for IRV relationships)
      - ETMP03 # Get active relationships (via HIP - queries ETMP, cached 15 min)
      - MongoDB.invitations.READ
      - MongoDB.partial-auth.READ
      - MongoDB.customer-status-cache.READ
      - MongoDB.customer-status-cache.WRITE
  - id: ACR25
    method: PUT
    path: /cleanup-invitation-status
    description: Administrative/cleanup endpoint that deauthorises accepted or partial-auth invitations when relationships are terminated externally. Updates invitation status from Accepted/PartialAuth to DeAuthorised, sets relationshipEndedBy to 'HMRC', and updates lastUpdated. Validates service and clientId format. Returns 404 if no matching Accepted/PartialAuth invitation found. Does NOT terminate relationships in EACD/ETMP - only updates invitation record for consistency. Used by cleanup jobs.
    audience: internal
    interaction: synchronous
    consumes:
      - MongoDB.invitations.UPDATE
  - id: ACR27
    method: POST
    path: /stride/active-relationships
    description: VERY HIGH COMPLEXITY - Bulk endpoint for Stride users to retrieve ALL active agent-client relationships for multiple clients in single request. Supports all client types (NINO, VRN, UTR, URN, CGT, PPT, CBC, PLR). For NINO, retrieves relationships from three sources in parallel (ITSA via HIP/IF, IRV via agent-fi-relationship, PartialAuth from MongoDB). Each relationship enriched with agent names from agent-maintainer and client names from DES. No partial success - entire request fails if any client fails. Requires Stride authentication with maintain_agent_relationships or maintain_agent_manually_assure role.
    audience: internal
    interaction: synchronous
    consumes:
      - ETMP03 # Get active relationships (via HIP)
      - ETMP05 # Get NINO for MTD IT ID (NINO-to-MtdItId conversion)
      - AFR01 # Get relationship for NINO (IRV relationships)
      - CD02 # Get citizen details by NINO (client names)
      - MongoDB.partial-auth.READ
      # DES: designatory-details (NINO client details)
      # agent-maintainer: for agent names
  - id: ACR28
    method: GET
    path: /stride/client-details/service/{service}/client/{clientIdType}/{clientId}
    description: Stride endpoint to retrieve comprehensive client details including client name, pending invitations (non-suspended agents only), and active main agent relationship. For MTD-IT, automatically queries both MTD-IT and MTD-IT-SUPP invitations and checks PartialAuth for main agent (takes precedence over HIP). Suspended agents' invitations are filtered out. Client name prioritized from invitation, otherwise retrieved from DES. IRV service queries agent-fi-relationship. Graceful degradation - individual query failures don't fail entire request. Returns 404 only if client name cannot be determined. Requires Stride authentication with maintain_agent_relationships or maintain_agent_manually_assure role.
    audience: internal
    interaction: synchronous
    consumes:
      # agent-maintainer: for agent names and suspension status
      - ETMP03 # Get active relationships (via HIP - not called for IRV or if PartialAuth exists for MTD-IT)
      - ETMP05 # Get NINO for MTD IT ID (NINO-to-MtdItId conversion for MTD-IT)
      - AFR01 # Get relationship for NINO (IRV relationships)
      - CD02 # Get citizen details by NINO (client names)
      - MongoDB.invitations.READ
      - MongoDB.partial-auth.READ
      # DES: designatory-details, subscription endpoints (client names)
  - id: ACR29
    method: GET
    path: /stride/irv-relationships/{nino}
    description: Stride endpoint to retrieve active IRV (Income Record Viewer / Personal Income Record) relationships for a client NINO. Validates NINO format, queries agent-fi-relationship service (NOT HIP) for active IRV relationships, enriches each with agent name from agent-maintainer, retrieves client name from DES Citizen Details. IRV relationships managed separately from HIP/ETMP. RelationshipNotFound and RelationshipSuspended gracefully recovered as empty agents array (returns 200 with no agents). Returns 404 only if client not found in DES. Each agent ARN requires agent-maintainer call. Requires Stride authentication with maintain_agent_relationships or maintain_agent_manually_assure role.
    audience: internal
    interaction: synchronous
    consumes:
      - AFR01 # Get relationship for NINO (IRV relationships)
      - CD02 # Get citizen details by NINO (client name)
      # agent-maintainer: for agent names
  - id: ACR30
    method: GET
    path: /stride/partial-auths/nino/{nino}
    description: Retrieves partial authorizations via STRIDE for the specified NINO.
    audience: internal
    interaction: synchronous
    consumes:
      - CD02 # Get citizen details by NINO
      - MongoDB.partial-auth.READ
  - id: ACR31
    method: POST
    path: /api/{arn}/invitation
    description: VERY HIGH COMPLEXITY - External OAuth2 API endpoint for third-party platforms to create agent authorization invitations. Extensive validation pipeline includes payload validation, agent suspension check (agent-maintainer), client registration check (DES), known facts verification, duplicate invitation check (MongoDB), MTD-IT/MTD-IT-SUPP cross-check, existing relationship check (HIP via CheckRelationshipsOrchestratorService and PartialAuth for ITSA). For MTD-IT/MTD-IT-SUPP converts NINO to MtdItId via IF. Creates invitation with expiry date, sends audit event. Returns 403 for agent suspended or known fact mismatch, 422 for business rule violations, 201 Created with invitationId on success. Fail-fast approach with multiple sequential validations.
    audience: external-authenticated
    interaction: synchronous
    consumes:
      - ETMP05 # Get NINO for MTD IT ID (NINO-to-MtdItId conversion for MTD-IT/MTD-IT-SUPP)
      # agent-maintainer: for agent record and suspension check
      - CD02 # Get citizen details by NINO
      - MongoDB.invitations.READ
      - MongoDB.invitations.WRITE
      - MongoDB.partial-auth.READ
      # DES: multiple endpoints for client details (getVrnDisplayDetails, getTrustDetails, etc.)
      # Uses ACR01 CheckRelationshipsOrchestratorService for existing relationship check
  - id: ACR32
    method: GET
    path: /api/{arn}/invitation/{invitationId}
    description: Retrieves a specific invitation via API for the agent.
    audience: external-authenticated
    interaction: synchronous
    consumes:
      - MongoDB.invitations.READ
      - MongoDB.agent-reference.READ
  - id: ACR33
    method: GET
    path: /api/{arn}/invitations
    description: Retrieves all invitations via API for the agent.
    audience: external-authenticated
    interaction: synchronous
    consumes:
      - MongoDB.invitations.READ_MANY
      - MongoDB.agent-reference.READ
  - id: ACR34
    method: POST
    path: /api/{arn}/relationship
    description: External OAuth2 API endpoint that checks if an active agent-client relationship exists for a specific service. Similar to ACR01 but uses known fact verification instead of user authentication. Uses full CheckRelationshipsOrchestratorService flow. Validates agent not suspended, client registered, known fact matches, and client not insolvent before checking relationship. Returns 204 No Content if relationship exists, appropriate error codes otherwise.
    audience: external-authenticated
    interaction: synchronous
    consumes:
      - AA27 # Get agent record by ARN (agent suspension check)
      - CD02 # Get citizen details by NINO
      # DES/IF: client registration details via ClientDetailsService
      # Uses ACR01 CheckRelationshipsOrchestratorService flow (ES3, ES1, UGS01, ES2, AP06, ETMP06, DES08, AM09, AFR01)
