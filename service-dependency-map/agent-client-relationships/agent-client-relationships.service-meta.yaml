service: agent-client-relationships
repository: https://github.com/hmrc/agent-client-relationships
capabilities: []
audience:
  - internal
interaction: synchronous
criticality: high
lifecycle: active
dependencies:
  consumes: []
  produces: []
tags: []
apis:
  - id: ACR01
    method: GET
    path: /agent/{arn}/service/{service}/client/{clientIdType}/{clientId}
    description: Checks if a relationship exists between an agent and a client for a specific service.
    audience: internal
    interaction: synchronous
    consumes:
      - EACD  # enrolment-store-proxy - gets principal group ID, delegated group IDs, user enrolments
      - users-groups-search  # UGS - gets group users for user-level permission checks
      - agent-permissions  # AP - checks if client is assigned to access groups
      - IF/HIP  # HIP - converts NINO to MtdItId for MTD-IT services
      - DES  # Gets SA agent references from CESA for legacy relationship checks
      - agent-mapping  # AM - maps ARN to legacy SA agent references
      - agent-fi-relationship  # AFI - handles PIR (Personal Income Record) relationship checks
      - agent-assurance  # AA - checks agent suspension status for IR-SA
  - id: ACR02
    method: GET
    path: /agent/relationships/inactive
    description: Retrieves a list of inactive (terminated) relationships for the authenticated agent from ETMP via HIP.
    audience: internal
    interaction: synchronous
    consumes:
      - IF/HIP  # Queries ETMP via REST Adapter for inactive agent relationships (last 30 days)
      - ETMP  # Enterprise Tax Management Platform - stores historical relationship records
  - id: ACR03
    method: DELETE
    path: /agent/{arn}/terminate
    description: Administrative endpoint that deletes internal tracking records from MongoDB for a terminated agent. Does NOT terminate actual relationships in EACD.
    audience: internal
    interaction: synchronous
    consumes: []  # Only queries internal MongoDB - no external services called
  - id: ACR04
    method: GET
    path: /agent/{arn}/client/{nino}/legacy-mapped-relationship
    description: Checks if a client has a legacy SA relationship in CESA and whether it has been mapped to the agent's ARN. Returns 204 if mapped, 200 if exists but not mapped, 404 if no legacy relationship.
    audience: internal
    interaction: synchronous
    consumes:
      - DES  # Queries /registration/relationship/nino/:nino for client's SA agent references in CESA
      - agent-mapping  # Queries /agent-mapping/mappings/:arn for agent's mapped SA references
  - id: ACR05
    method: GET
    path: /client/relationships/active
    description: Retrieves all active agent relationships for the authenticated client across all their enrolled services (excluding PIR). Returns map of service IDs to agent ARNs.
    audience: internal
    interaction: synchronous
    consumes:
      - IF/HIP  # Queries ETMP via REST Adapter for active agent relationships per service
      - ETMP  # Enterprise Tax Management Platform - stores agent-client relationship records
  - id: ACR06
    method: GET
    path: /client/relationships/inactive
    description: Retrieves all inactive (terminated) agent relationships for the authenticated client across all their enrolled services (excluding PIR). Returns flat array of InactiveRelationship objects.
    audience: internal
    interaction: synchronous
    consumes:
      - IF/HIP  # Queries ETMP via REST Adapter for inactive agent relationships per service
      - ETMP  # Enterprise Tax Management Platform - stores historical agent-client relationship records
  - id: ACR07
    method: GET
    path: /client/relationships/service/{service}
    description: Retrieves the active agent relationship for a specific service for the authenticated client. Client must be enrolled for the specific service. Returns single ActiveRelationship or 404.
    audience: internal
    interaction: synchronous
    consumes:
      - IF/HIP  # Queries ETMP via REST Adapter for active agent relationship for the specific service
      - ETMP  # Enterprise Tax Management Platform - stores agent-client relationship records
  - id: ACR08
    method: GET
    path: /client/authorisations-relationships
    description: Most complex endpoint - retrieves comprehensive tax agent data combining active/inactive relationships, pending invitations, event timeline, and agent details. Queries 4 sources in parallel (ETMP, agent-fi-relationship, invitations DB, partial_auth DB) with agent name enrichment.
    audience: internal
    interaction: synchronous
    consumes:
      - IF/HIP  # Queries ETMP for relationships per service
      - ETMP  # Stores agent-client relationship records
      - agent-fi-relationship  # PIR (Personal Income Record) relationships
      - MongoDB  # invitations collection (pending/expired/rejected/cancelled)
      - MongoDB  # partial_auth collection (IR-SA partial authorizations)
  - id: ACR09
    method: GET
    path: /client/{service}/details/{clientId}
    description: Retrieves client details (name, known facts, overseas status) from external APIs, then enriches with pending invitation and existing relationship checks. For MTD-IT checks both main and supporting services. Uses full ACR01 flow for relationship checks.
    audience: internal
    interaction: synchronous
    consumes:
      - citizen-details  # PIR (Personal Income Record) client details
      - IF/HIP  # All other tax service client subscription/registration details
      - MongoDB  # invitations collection (pending invitation checks)
      - MongoDB  # partial_auth collection (MTD-IT/MTD-IT-SUPP partial auth fallback)
  - id: ACR10
    method: GET
    path: /agent/agent-reference/uid/{uid}/{normalizedAgentName}
    description: Public endpoint (no auth) that validates agent invitation links. Verifies UID exists, normalized name matches (from array of names), and agent not suspended. Returns agent details or 404/403. Two-factor security prevents link guessing.
    audience: internal
    interaction: synchronous
    consumes:
      - agent-assurance  # Checks agent suspension status and retrieves agent details
      - MongoDB  # agent-reference collection (UID lookup, encrypted normalized names array)
  - id: ACR11
    method: GET
    path: /agent/agent-link
    description: Idempotent create/get agent invitation link. First call generates UID and creates record. Subsequent calls return existing UID. When agency name changes, adds new normalized name to array (old links continue working). Works even if agent suspended.
    audience: internal
    interaction: synchronous
    consumes:
      - agent-assurance  # Retrieves current agent details including agency name (uses getAgentRecord, not getNonSuspendedAgentRecord)
      - MongoDB  # agent-reference collection (find by ARN, create/update with $addToSet for name array)
  - id: ACR12
    method: POST
    path: /client/validate-invitation
    description: Validates invitation for authenticated client. Checks UID, agent suspension, finds matching invitations (Pending first, else most recent), and checks for existing main agent. Returns invitation details with existingMainAgent info. Handles service mappings (HMRC-NI/PT â†’ MTD-IT/PIR).
    audience: internal
    interaction: synchronous
    consumes:
      - agent-assurance  # Agent suspension check and existing agent details
      - EACD  # Enrolment Store Proxy - checks for existing agent delegations
      - agent-fi-relationship  # PIR relationship checks
      - MongoDB  # agent-reference (UID lookup), invitations (matching invitation queries)
  - id: ACR13
    method: GET
    path: /client/authorisation-request-info/{invitationId}
    description: Gets basic invitation info (agent name, service, status) for agent OR client. Unusual auth pattern - lookups invitation first, then validates user is agent (matching ARN) OR client (matching clientId). Returns details even if agent suspended.
    audience: internal
    interaction: synchronous
    consumes:
      - agent-assurance  # Retrieves agent details including agency name (uses getAgentRecord, not getNonSuspendedAgentRecord)
      - MongoDB  # invitations collection (lookup by invitationId)
  - id: ACR14
    method: GET
    path: /agent/{arn}/details
    description: Simple passthrough to agent-assurance - retrieves agent details (name, email, suspension status). Agent auth required but no validation that ARN matches authenticated agent (any agent can query any agent). Returns details even if agent suspended.
    audience: internal
    interaction: synchronous
    consumes:
      - agent-assurance  # getAgentRecord (not getNonSuspendedAgentRecord) - returns details even if suspended
  - id: ACR15
    method: PUT
    path: /client/authorisation-response/reject/{invitationId}
    description: Client or Stride user rejects pending invitation. Two-phase auth (lookup first, validate after). Updates status to Rejected, sends email to agent, audits event. Returns 204 No Content. Can only reject Pending invitations (403 for other statuses).
    audience: internal
    interaction: synchronous
    consumes:
      - MongoDB  # invitations collection (lookup and update status to Rejected)
      - EmailService  # Sends rejection notification to agent
  - id: ACR16
    method: PUT
    path: /authorisation-response/accept/{invitationId}
    description: MOST COMPLEX ENDPOINT - Client or Stride accepts invitation and CREATES actual relationship in EACD (allocateEnrolmentToAgent) and/or ETMP. Service-specific flows for PIR/MTD-IT/MTD-IT-SUPP/Alt-ITSA/others. Deauths existing agents, manages partial auth, updates status to Accepted/PartialAuth, sends email. Can return 423 Locked.
    audience: internal
    interaction: synchronous
    consumes:
      - EACD  # Enrolment Store Proxy - allocateEnrolmentToAgent creates delegation
      - ETMP  # via HIP - creates tax service relationships
      - agent-fi-relationship  # Creates PIR relationships
      - MongoDB  # invitations (update status), partial_auth (create/delete for Alt-ITSA)
      - EmailService  # Sends acceptance confirmation
  - id: ACR17
    method: POST
    path: /agent/{arn}/authorisation-request
    description: Agent creates invitation (Pending status). Gets agent details from agent-assurance. For MTD-IT/MTD-IT-SUPP with NINO, converts to MTD IT ID via IF/HIP (uses NINO if not found for alt-itsa). Prevents duplicates via MongoDB unique index. Returns 201 with invitationId. Does NOT send email.
    audience: internal
    interaction: synchronous
    consumes:
      - agent-assurance  # Retrieves agent details (agency name, email)
      - IF/HIP  # Converts NINO to MTD IT ID (MTD-IT/MTD-IT-SUPP only)
      - MongoDB  # invitations collection (INSERT with Pending status, unique index prevents duplicates)
  - id: ACR18
    method: GET
    path: /agent/{arn}/authorisation-request-info/{invitationId}
    description: Retrieves details about a specific authorisation request (invitation) for an agent, including a shareable invitation link. Returns full invitation details with generated link (UID and normalized agent name) for client onboarding. Creates or retrieves agent-reference record with unique UID. Returns details even if agent suspended.
    audience: internal
    interaction: synchronous
    consumes:
      - agent-assurance  # Retrieves agent details including agency name (uses getAgentRecord, not getNonSuspendedAgentRecord)
      - MongoDB  # invitations collection (lookup by arn and invitationId), agent-reference collection (find/create/update with normalized names array)
  - id: ACR19
    method: GET
    path: /agent/{arn}/authorisation-requests
    description: Retrieves paginated and filtered list of authorisation requests (invitations) for an agent. Uses MongoDB aggregation with facets for efficient querying (single query returns data + metadata). Returns requests filtered by status and client name, plus metadata (clientNames, availableFilters, totalResults, filtersApplied). Special handling - 'Accepted' filter includes PartialAuth. Primary endpoint for agent dashboards.
    audience: internal
    interaction: synchronous
    consumes:
      - MongoDB  # invitations collection (aggregation pipeline with facets - filter by ARN, sort by created desc, return paginated results + metadata)
  - id: ACR20
    method: POST
    path: /agent/{arn}/remove-authorisation
    description: HIGH COMPLEXITY - Removes existing authorisation between agent and client. Three distinct flows - 1) PIR delegates to agent-fi-relationship. 2) Alt-ITSA (MTD-IT/ITSUPP+NINO) deauths partial-auth and updates invitations. 3) Standard services perform full deletion with EACD enrolment deallocation and ETMP relationship removal. Uses recovery mechanism with delete-record tracking. Not atomic. Supports agent/client/Stride auth.
    audience: internal
    interaction: synchronous
    consumes:
      - agent-fi-relationship  # PIR service only - delegates deletion
      - EACD  # Standard services - getPrincipalGroupIdFor, deallocateEnrolmentFromAgent
      - IF/HIP  # Standard services - deleteAgentRelationship. Alt-ITSA - getMtdIdFor (NINO to MTDITID conversion)
      - MongoDB  # invitations (UPDATE to Deauthorised for all flows), partial-auth (UPDATE expiryDate for alt-ITSA), delete-record (INSERT/READ/UPDATE/DELETE for standard services recovery mechanism)
  - id: ACR21
    method: PUT
    path: /agent/cancel-invitation/{invitationId}
    description: Allows agent to cancel pending authorisation request (invitation) they previously sent to client. Only Pending status invitations can be cancelled. Agent must own invitation (ARN must match). Atomic update with validation prevents race conditions. Updates status to Cancelled and lastUpdated timestamp. Client can no longer accept cancelled invitation. Does not send email notification to client.
    audience: internal
    interaction: synchronous
    consumes:
      - MongoDB  # invitations collection (READ by invitationId, validate status=Pending and arn match, UPDATE status to Cancelled and lastUpdated timestamp)
  - id: ACR22
    method: POST
    path: /itsa-post-signup/create-relationship/{nino}
    description: HIGH COMPLEXITY - Creates ITSA (MTD-IT) relationship for client after MTD signup. Two flows - 1) Partial auth conversion (converts existing partial auth to full relationship, deletes partial auth, updates invitation to Accepted). 2) Legacy SA copy (copies SA relationship from CESA/DES to MTD-IT if no partial auth). Converts NINO to MTDITID via HIP. Uses recovery mechanism. Cleans up duplicate same-agent relationships. Returns service in response.
    audience: internal
    interaction: synchronous
    consumes:
      - HIP/IF  # getMtdIdFor (NINO to MTDITID conversion), createAgentRelationship (ETMP relationship creation)
      - DES  # getClientSaAgentSaReferences (legacy SA copy flow only - retrieves SA agent references)
      - EACD  # getPrincipalGroupIdFor, allocateEnrolmentToAgent (both flows - enrolment allocation)
      - MongoDB  # partial-auth (READ/DELETE for partial auth flow), invitations (UPDATE PartialAuth to Accepted), relationship-copy-record (INSERT/DELETE for recovery tracking)
  - id: ACR23
    method: POST
    path: /invitations/trusts-enrolment-orchestrator/{urn}/update
    description: Updates a trust-related invitation by replacing the temporary URN with the permanent UTR after trust registration completes. Called by Trusts Enrolment Orchestrator when trust transitions from non-taxable (HMRC-TERSNT-ORG) to taxable (HMRC-TERS-ORG) status. Updates invitation record atomically (service, clientId, clientIdType, suppliedClientId, suppliedClientIdType, lastUpdated). No authentication required - internal service call.
    audience: internal
    interaction: synchronous
    consumes:
      - MongoDB  # invitations collection (UPDATE by service=HMRC-TERSNT-ORG, clientId=URN to service=HMRC-TERS-ORG, clientId=UTR)
  - id: ACR24
    method: GET
    path: /customer-status
    description: MEDIUM COMPLEXITY - Returns client relationship status summary with three boolean flags (hasPendingInvitations, hasInvitationsHistory, hasExistingRelationships). Filters out suspended agent invitations via Agent Assurance. Checks multiple sources (invitations, partial auth, IRV, ETMP). Uses 15-min caching for ETMP queries. Short-circuits ETMP check if active partial auth, IRV, or PartialAuth/Accepted invitation exists.
    audience: internal
    interaction: synchronous
    consumes:
      - Agent Assurance (API 2007)  # GET /agent-record/{arn} - checks agent suspension status for filtering invitations
      - Agent FI Relationship  # GET /agent-fi-relationship/relationships/active - checks for IRV relationships
      - HIP/IF  # GET /agent-client-relationships/client/relationships/active - queries ETMP for active relationships (cached, 15 min TTL)
      - ETMP  # Via HIP - source of truth for active relationships
      - MongoDB  # invitations (READ by service/clientId, filter suspended agents), partial-auth (READ by NINO), customer-status-cache (READ/WRITE, 15 min TTL)
  - id: ACR25
    method: PUT
    path: /cleanup-invitation-status
    description: Administrative/cleanup endpoint that deauthorises accepted or partial-auth invitations when relationships are terminated externally. Updates invitation status from Accepted/PartialAuth to DeAuthorised, sets relationshipEndedBy to 'HMRC', and updates lastUpdated. Validates service and clientId format. Returns 404 if no matching Accepted/PartialAuth invitation found. Does NOT terminate relationships in EACD/ETMP - only updates invitation record for consistency. Used by cleanup jobs.
    audience: internal
    interaction: synchronous
    consumes:
      - MongoDB  # invitations collection (UPDATE status from Accepted/PartialAuth to DeAuthorised by arn, service, clientId)
  - id: ACR26
    method: GET
    path: /relationships/service/{service}/client/{clientIdType}/{clientId}
    description: Allows a Stride user (HMRC internal staff) to retrieve active agent-client relationships for a specific client. Validates service and client identifier, queries HIP (ETMP) for active relationships. Special handling for ITSA services (requires NINO-to-MtdItId conversion via IF) and CBC services (queries EACD to determine CBC-ORG vs CBC-NONUK-ORG). Only returns relationships with dateTo = 9999-12-31. Requires Stride authentication with maintain_agent_relationships or maintain_agent_manually_assure role.
    audience: internal
    interaction: synchronous
    consumes:
      - EACD (for CBC service validation only)
      - IF (for ITSA NINO-to-MtdItId conversion)
      - HIP
  - id: ACR27
    method: POST
    path: /stride/active-relationships
    description: VERY HIGH COMPLEXITY - Bulk endpoint for Stride users to retrieve ALL active agent-client relationships for multiple clients in single request. Supports all client types (NINO, VRN, UTR, URN, CGT, PPT, CBC, PLR). For NINO, retrieves relationships from three sources in parallel (ITSA via HIP/IF, IRV via agent-fi-relationship, PartialAuth from MongoDB). Each relationship enriched with agent names from agent-maintainer and client names from DES. No partial success - entire request fails if any client fails. Requires Stride authentication with maintain_agent_relationships or maintain_agent_manually_assure role.
    audience: internal
    interaction: synchronous
    consumes:
      - HIP
      - IF (for NINO-to-MtdItId conversion)
      - agent-fi-relationship (for IRV relationships)
      - citizen-details (DES - for client names)
      - designatory-details (DES - for NINO client details)
      - agent-maintainer (for agent names)
    database:
      - partial-auth (for PartialAuth relationships)
  - id: ACR28
    method: GET
    path: /stride/client-details/service/{service}/client/{clientIdType}/{clientId}
    description: Stride endpoint to retrieve comprehensive client details including client name, pending invitations (non-suspended agents only), and active main agent relationship. For MTD-IT, automatically queries both MTD-IT and MTD-IT-SUPP invitations and checks PartialAuth for main agent (takes precedence over HIP). Suspended agents' invitations are filtered out. Client name prioritized from invitation, otherwise retrieved from DES. IRV service queries agent-fi-relationship. Graceful degradation - individual query failures don't fail entire request. Returns 404 only if client name cannot be determined. Requires Stride authentication with maintain_agent_relationships or maintain_agent_manually_assure role.
    audience: internal
    interaction: synchronous
    consumes:
      - agent-maintainer (for agent names and suspension status)
      - HIP (for relationships - not called for IRV or if PartialAuth main agent found for MTD-IT)
      - IF (for NINO-to-MtdItId conversion for MTD-IT)
      - agent-fi-relationship (for IRV relationships)
      - citizen-details (DES - for client names)
      - designatory-details (DES - for NINO details)
      - DES subscription endpoints (for client names per type)
    database:
      - invitations (for pending invitations)
      - partial-auth (for MTD-IT main agent check)
  - id: ACR29
    method: GET
    path: /stride/irv-relationships/{nino}
    description: Stride endpoint to retrieve active IRV (Income Record Viewer / Personal Income Record) relationships for a client NINO. Validates NINO format, queries agent-fi-relationship service (NOT HIP) for active IRV relationships, enriches each with agent name from agent-maintainer, retrieves client name from DES Citizen Details. IRV relationships managed separately from HIP/ETMP. RelationshipNotFound and RelationshipSuspended gracefully recovered as empty agents array (returns 200 with no agents). Returns 404 only if client not found in DES. Each agent ARN requires agent-maintainer call. Requires Stride authentication with maintain_agent_relationships or maintain_agent_manually_assure role.
    audience: internal
    interaction: synchronous
    consumes:
      - agent-fi-relationship (for IRV relationships - AFR03)
      - citizen-details (DES - for client name)
      - agent-maintainer (for agent names)
  - id: ACR30
    method: GET
    path: /stride/partial-auths/nino/{nino}
    description: Retrieves partial authorizations via STRIDE for the specified NINO.
    audience: internal
    interaction: synchronous
    consumes:
      - citizen-details
  - id: ACR31
    method: POST
    path: /api/{arn}/invitation
    description: VERY HIGH COMPLEXITY - External OAuth2 API endpoint for third-party platforms to create agent authorization invitations. Extensive validation pipeline includes payload validation, agent suspension check (agent-maintainer), client registration check (DES), known facts verification, duplicate invitation check (MongoDB), MTD-IT/MTD-IT-SUPP cross-check, existing relationship check (HIP via CheckRelationshipsOrchestratorService and PartialAuth for ITSA). For MTD-IT/MTD-IT-SUPP converts NINO to MtdItId via IF. Creates invitation with expiry date, sends audit event. Returns 403 for agent suspended or known fact mismatch, 422 for business rule violations, 201 Created with invitationId on success. Fail-fast approach with multiple sequential validations.
    audience: external-authenticated
    interaction: synchronous
    consumes:
      - IF (for NINO-to-MtdItId conversion - MTD-IT/MTD-IT-SUPP only)
      - agent-maintainer (for agent record and suspension check)
      - DES (multiple endpoints for client details - getCitizenDetails, getVrnDisplayDetails, getTrustDetails, etc.)
      - HIP (via CheckRelationshipsOrchestratorService for existing relationship check)
    database:
      - invitations (check for duplicates, create new invitation)
      - partial-auth (check for existing PartialAuth - ITSA only)
  - id: ACR32
    method: GET
    path: /api/{arn}/invitation/{invitationId}
    description: Retrieves a specific invitation via API for the agent.
    audience: external-authenticated
    interaction: synchronous
    consumes: []
  - id: ACR33
    method: GET
    path: /api/{arn}/invitations
    description: Retrieves all invitations via API for the agent.
    audience: external-authenticated
    interaction: synchronous
    consumes: []
  - id: ACR34
    method: POST
    path: /api/{arn}/relationship
    description: External OAuth2 API endpoint that checks if an active agent-client relationship exists for a specific service. Similar to ACR01 but uses known fact verification instead of user authentication. Uses full CheckRelationshipsOrchestratorService flow. Validates agent not suspended, client registered, known fact matches, and client not insolvent before checking relationship. Returns 204 No Content if relationship exists, appropriate error codes otherwise.
    audience: external-authenticated
    interaction: synchronous
    consumes:
      - agent-assurance (for agent suspension check)
      - DES/IF (for client registration details via ClientDetailsService - service-specific endpoints)
      - EACD (via CheckRelationshipsOrchestratorService - same as ACR01)
      - UGS (via CheckRelationshipsOrchestratorService - same as ACR01)
      - agent-permissions (via CheckRelationshipsOrchestratorService - same as ACR01)
      - IF/HIP (via CheckRelationshipsOrchestratorService - NINO to MtdItId conversion for MTD-IT)
      - DES (via CheckRelationshipsOrchestratorService - SA agent references for legacy checks)
      - agent-mapping (via CheckRelationshipsOrchestratorService - ARN to SA reference mapping)
      - agent-fi-relationship (via CheckRelationshipsOrchestratorService - PIR relationship checks)
