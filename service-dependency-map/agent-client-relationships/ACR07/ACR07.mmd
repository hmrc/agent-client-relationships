sequenceDiagram
    participant Client
    participant RC as RelationshipsController
    participant FRS as FindRelationshipsService
    participant HIP as IF/HIP (HipConnector)
    participant ETMP as ETMP (via HIP REST Adapter)

    Client->>+RC: GET /client/relationships/service/:service
    Note over RC: authorisedAsClient(service)<br/>Check enrolment for specific service

    RC->>RC: Validate client has enrolment for service<br/>Extract tax identifier from enrolment

    alt Client has enrolment AND Individual/Organisation
        RC->>+FRS: getActiveRelationshipsForClient(taxId, service)

        alt Supported tax identifier type
            FRS->>+HIP: getActiveClientRelationships(taxId, service)

            HIP->>HIP: Build HIP URL with:<br/>- taxIdentifier<br/>- authProfile for service<br/>- activeOnly=true

            HIP->>+ETMP: GET /etmp/RESTAdapter/rosm/agent-relationship<br/>?idType={idType}&refNumber={taxId}<br/>&auth-profile={authProfile}&active-only=true
            Note over HIP,ETMP: Includes HIP subscription headers

            alt Success (200 OK)
                ETMP-->>-HIP: relationshipDisplayResponse array
                HIP->>HIP: Find first isActive relationship<br/>(dateFrom <= today, dateTo empty or future)
                HIP-->>-FRS: Option[ActiveRelationship]
            else Client Error (400/404)
                ETMP-->>HIP: Error response
                HIP-->>FRS: None
            else Agent Suspended (422 with "suspended")
                ETMP-->>HIP: Unprocessable Entity
                HIP-->>FRS: None
            else ETMP Error Code 009 (422)
                ETMP-->>HIP: Unprocessable Entity
                HIP-->>FRS: None
            else Other Error
                ETMP-->>HIP: Error response
                Note over HIP: Log error
                HIP-->>FRS: None
            end
        else Unsupported tax identifier type
            FRS->>FRS: Log warning
            FRS-->>-RC: None
        end

        alt ActiveRelationship found
            RC-->>Client: 200 OK with JSON
        else No relationship
            RC-->>-Client: 404 Not Found
        end
    else No enrolment OR wrong affinity group
        RC-->>Client: 403 Forbidden<br/>(NoPermissionToPerformOperation)
    end

