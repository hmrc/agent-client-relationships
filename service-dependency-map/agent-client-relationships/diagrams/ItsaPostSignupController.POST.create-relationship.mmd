sequenceDiagram
    autonumber
    participant Upstream
    participant agent-client-relationships
    participant if-or-hip
    participant Database
    participant des
    participant enrolment-store-proxy

    Upstream->>+agent-client-relationships: POST /itsa-post-signup/create-relationship/:nino
    agent-client-relationships->>+if-or-hip: GET /registration/individual/nino/:nino
    if-or-hip-->>-agent-client-relationships: Response (MTDITID)
    
    alt Partial Auth Exists
        agent-client-relationships->>Database: Read/Update: Check for and use partial-auth record.
        Database-->>agent-client-relationships: Response
    else Legacy SA Relationship Exists
        agent-client-relationships->>+des: GET /registration/relationship/nino/:nino
        des-->>-agent-client-relationships: Response (Legacy SA Agents)
        agent-client-relationships->>+enrolment-store-proxy: POST /enrolment-store-proxy/enrolment-store/groups/:groupId/enrolments/:enrolmentKey
        enrolment-store-proxy-->>-agent-client-relationships: Response
    end

    agent-client-relationships-->>-Upstream: Final Response
