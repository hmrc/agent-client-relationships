{
    "apiId": "ACR02",
    "apiTitle": "Get Inactive Agent Relationships",
    "description": "Retrieves a list of all inactive (terminated) relationships for the authenticated agent from ETMP via HIP. Returns relationships that ended in the last 30 days where the dateTo is on or before today. Results are cached to improve performance.",
    "method": "GET",
    "path": "/agent/relationships/inactive",
    "pathParameters": {},
    "queryParameters": {},
    "responses": {
        "200": "Returns array of inactive relationships with agent ARN, client ID, service, dates, and client type",
        "404": "No inactive relationships found for the agent",
        "401": "Unauthorized - agent authentication required"
    },
    "authentication": "Agent authentication via withAuthorisedAsAgent",
    "audience": "internal",
    "controller": "RelationshipsController",
    "controllerMethod": "getInactiveRelationshipsAgent",
    "services": [
        {
            "name": "FindRelationshipsService",
            "alias": "FRS",
            "method": "getInactiveRelationshipsForAgent",
            "description": "Delegates to HIP connector to retrieve inactive relationships"
        },
        {
            "name": "HipConnector",
            "alias": "HIP",
            "method": "getInactiveRelationships",
            "description": "Calls ETMP via HIP REST Adapter to get inactive agent relationships"
        },
        {
            "name": "AgentCacheProvider",
            "alias": "Cache",
            "method": "agentTrackPageCache",
            "description": "Caches inactive relationships by ARN and date to reduce ETMP calls"
        }
    ],
    "interactions": [
        {
            "step": 1,
            "actor": "RelationshipsController (RC)",
            "action": "authenticates",
            "target": "Agent",
            "method": "withAuthorisedAsAgent",
            "description": "Validates agent authentication and extracts ARN from enrolment"
        },
        {
            "step": 2,
            "actor": "RelationshipsController (RC)",
            "action": "calls service",
            "target": "FindRelationshipsService (FRS)",
            "method": "getInactiveRelationshipsForAgent",
            "description": "Requests inactive relationships for the authenticated agent"
        },
        {
            "step": 3,
            "actor": "FindRelationshipsService (FRS)",
            "action": "calls connector",
            "target": "HipConnector (HIP)",
            "method": "getInactiveRelationships",
            "description": "Delegates to HIP connector to retrieve relationships from ETMP"
        },
        {
            "step": 4,
            "actor": "HipConnector (HIP)",
            "action": "checks cache",
            "target": "AgentCacheProvider (Cache)",
            "method": "agentTrackPageCache",
            "description": "Checks if results are cached for key '{arn}-{today}'"
        },
        {
            "step": 5,
            "actor": "HipConnector (HIP)",
            "action": "calls external API",
            "target": "IF/HIP â†’ ETMP",
            "endpoint": "/etmp/RESTAdapter/rosm/agent-relationship",
            "method": "GET",
            "queryParams": {
                "arn": "Agent Reference Number",
                "isAnAgent": "true",
                "activeOnly": "false",
                "regime": "AGSV (Agent Services)",
                "dateFrom": "30 days ago (configurable)",
                "dateTo": "Today's date"
            },
            "description": "Calls ETMP via HIP REST Adapter to get agent relationships including inactive ones",
            "conditional": "only if cache miss"
        },
        {
            "step": 6,
            "actor": "ETMP",
            "action": "returns response",
            "target": "HipConnector (HIP)",
            "description": "Returns relationshipDisplayResponse array with all relationships in date range",
            "conditional": "on success (200 OK)"
        },
        {
            "step": 7,
            "actor": "HipConnector (HIP)",
            "action": "filters data",
            "target": "HipConnector (HIP)",
            "method": "isNotActive",
            "description": "Filters to only include relationships where dateTo is on or before today"
        },
        {
            "step": 8,
            "actor": "HipConnector (HIP)",
            "action": "stores in cache",
            "target": "AgentCacheProvider (Cache)",
            "description": "Caches filtered results to reduce subsequent ETMP calls",
            "conditional": "on successful retrieval"
        },
        {
            "step": 9,
            "actor": "HipConnector (HIP)",
            "action": "returns data",
            "target": "FindRelationshipsService (FRS)",
            "description": "Returns Seq[InactiveRelationship] with filtered results"
        },
        {
            "step": 10,
            "actor": "FindRelationshipsService (FRS)",
            "action": "returns data",
            "target": "RelationshipsController (RC)",
            "description": "Passes through the inactive relationships"
        },
        {
            "step": 11,
            "actor": "RelationshipsController (RC)",
            "action": "returns response",
            "target": "Agent",
            "description": "Returns 200 OK with JSON array if relationships found, 404 if empty"
        }
    ],
    "externalDependencies": [
        {
            "name": "IF/HIP",
            "alias": "HIP",
            "description": "HMRC Integration Platform - provides access to ETMP via REST Adapter"
        },
        {
            "name": "ETMP",
            "description": "Enterprise Tax Management Platform - stores agent-client relationship records"
        }
    ],
    "databaseCollections": [],
    "caching": {
        "enabled": true,
        "provider": "AgentCacheProvider",
        "cacheKey": "{arn}-{today}",
        "description": "Results are cached by ARN and current date to improve performance for repeated requests on the same day"
    },
    "errorHandling": [
        {
            "statusCode": "400 or 404",
            "handling": "Returns empty list (which results in 404 from controller)"
        },
        {
            "statusCode": "422 with 'suspended' message",
            "handling": "Agent is suspended - returns empty list"
        },
        {
            "statusCode": "422 with error code '009'",
            "handling": "ETMP error code - returns empty list"
        },
        {
            "statusCode": "Other errors",
            "handling": "Logs error and returns empty list"
        }
    ],
    "responseModel": {
        "InactiveRelationship": {
            "arn": "Agent Reference Number",
            "dateTo": "Optional[LocalDate] - date relationship ended (must be <= today to be included)",
            "dateFrom": "Optional[LocalDate] - date relationship started",
            "clientId": "Client identifier (MTD-IT ID, VRN, UTR, CGT ref, etc.)",
            "clientType": "Either 'personal' or 'business' based on ETMP response",
            "service": "Service identifier derived from clientId format (e.g., HMRC-MTD-IT, HMRC-MTD-VAT)"
        }
    },
    "configurationOptions": {
        "showInactiveRelationshipsDays": "Number of days back to query ETMP (default 30 days)"
    },
    "notes": [
        "Only returns relationships where dateTo is on or before today - active relationships are filtered out",
        "Results are cached per ARN per day to reduce load on ETMP",
        "Returns 404 if no inactive relationships found (empty list)",
        "Date range queried is configurable via showInactiveRelationshipsDays setting",
        "Service type is automatically determined from the clientId format",
        "Client type (personal/business) is derived from ETMP response structure",
        "HIP headers include subscription-specific authentication headers"
    ]
}

