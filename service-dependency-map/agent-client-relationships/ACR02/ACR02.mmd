sequenceDiagram
    participant Agent
    participant RC as RelationshipsController
    participant FRS as FindRelationshipsService
    participant Cache as AgentCacheProvider
    participant HIP as IF/HIP
    participant ETMP as ETMP (via HIP REST Adapter)

    Agent->>+RC: GET /agent/relationships/inactive
    Note over RC: withAuthorisedAsAgent(arn)

    RC->>+FRS: getInactiveRelationshipsForAgent(arn)
    FRS->>+HIP: getInactiveRelationships(arn)

    HIP->>+Cache: Check cache for key "{arn}-{today}"

    alt Cache hit
        Cache-->>HIP: Cached inactive relationships
    else Cache miss
        HIP->>+ETMP: GET /etmp/RESTAdapter/rosm/agent-relationship<br/>?arn={arn}&isAnAgent=true&activeOnly=false<br/>&regime=AGSV&dateFrom={30daysAgo}&dateTo={today}
        Note over HIP,ETMP: Includes HIP subscription headers

        alt Success (200 OK)
            ETMP-->>-HIP: relationshipDisplayResponse array
            HIP->>HIP: Filter relationships where dateTo <= today
            HIP->>Cache: Store in cache
        else Client Error (400/404)
            ETMP-->>HIP: Error response
            HIP->>HIP: Return empty list
        else Agent Suspended (422 with "suspended")
            ETMP-->>HIP: Unprocessable Entity
            HIP->>HIP: Return empty list
        else ETMP Error Code 009 (422)
            ETMP-->>HIP: Unprocessable Entity
            HIP->>HIP: Return empty list
        else Other Error
            ETMP-->>HIP: Error response
            Note over HIP: Log error
            HIP->>HIP: Return empty list
        end

        Cache-->>-HIP: Cached result
    end

    HIP-->>-FRS: Seq[InactiveRelationship]
    FRS-->>-RC: Seq[InactiveRelationship]

    alt relationships.nonEmpty
        RC-->>Agent: 200 OK with JSON array
    else relationships.isEmpty
        RC-->>-Agent: 404 Not Found
    end

